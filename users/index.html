<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Discipline Reports | GS GAKORO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Mobile scaling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 16px; 
      background: #f9f9f9; 
      margin: 0;
    }
    h1 { 
      color: #ff7a00; 
      font-size: 1.5rem; 
      text-align: center; 
    }
    label {
      font-weight: bold;
      display: block;
      margin: 10px 0 6px;
    }
    select, button {
      width: 100%; /* Full width for small screens */
      padding: 12px 14px;
      margin: 6px 0;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      box-sizing: border-box;
    }
    select { background: #eee; }
    button {
      background: #2066b2;
      color: white;
    }
    button:hover { background: #164d82; }
    .controls {
      max-width: 500px; 
      margin: auto;
    }
    .table-container {
      width: 100%;
      overflow-x: auto; /* Horizontal scroll on small screens */
      margin-top: 16px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px; /* Prevent table from squishing too much */
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      font-size: 0.9rem;
    }
    th {
      background: #ff7a00;
      color: white;
      font-weight: bold;
    }
    @media (min-width: 600px) {
      /* Buttons side by side on larger screens */
      .controls {
        display: flex;
        gap: 10px;
      }
      select, button {
        width: auto;
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <h1>GS GAKORO â€“ Discipline Reports</h1>

  <div class="controls">
    <select id="classSelect">
      <option value="">--Choose Class--</option>
      <option value="S1A">S1A</option>
      <option value="S1B">S1B</option>
      <option value="S1C">S1C</option>
      <option value="S2A">S2A</option>
      <option value="S2B">S2B</option>
      <option value="S3A">S3A</option>
      <option value="S3B">S3B</option>
    </select>
    <button onclick="loadSheet()">Preview</button>
    <button onclick="downloadPDF()">Download PDF</button>
  </div>

  <div class="table-container" id="preview"></div>

<script>
let currentClass = "";
let currentData = [];

async function loadSheet() {
  currentClass = document.getElementById("classSelect").value;
  if (!currentClass) { alert("Please select a class"); return; }

  const url = `https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3PA2uCJMkImTkjQz3K-FmgR3rJaTOuCpvN20S5vO-M9iznRDSkMyV6Px9IrSwFw8LWRBgRupp4NmL/pub?gid=${getGID(currentClass)}&single=true&output=csv`;
  
  try {
    const res = await fetch(url);
    const text = await res.text();
    const rows = text.split("\n").map(r => r.split(","));
    currentData = rows.map(r => r.slice(0,4)); // Only columns A-D
    renderTable(currentData);
  } catch(err) {
    console.error(err);
    document.getElementById("preview").innerHTML = "<p style='color:red'>Failed to load data. Make sure the sheet is published.</p>";
  }
}

function renderTable(values) {
  let html = "<table><thead><tr>";
  values[0].forEach(h => html += `<th>${h}</th>`);
  html += "</tr></thead><tbody>";
  for (let i = 1; i < values.length; i++) {
    html += "<tr>";
    values[i].forEach(c => html += `<td>${c}</td>`);
    html += "</tr>";
  }
  html += "</tbody></table>";
  document.getElementById("preview").innerHTML = html;
}

function downloadPDF() {
  if (!currentData.length) { alert("No data loaded. Please preview a class first."); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Header aligned left
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("GS GAKORO", 20, 15);
  doc.text("CLASS: " + currentClass, 20, 22);
  doc.text("ACADEMIC YEAR 2025-2026", 20, 29);

  // Title centered
  doc.setFontSize(16);
  doc.text("Discipline Report", 105, 45, { align: "center" });

  // Column widths
  let colWidths = currentData[0].map((_, colIndex) => {
    let maxLength = Math.max(...currentData.map(row => (row[colIndex] || "").length));
    return Math.min(Math.max(maxLength*2.8, 20), 80); // min 20, max 80
  });

  const startX = 20;
  let startY = 65;

  // Table header
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  let x = startX;
  currentData[0].forEach((header, i) => {
    doc.text(header, x + 2, startY + 7);
    doc.rect(x, startY, colWidths[i], 10);
    x += colWidths[i];
  });

  // Table rows
  doc.setFont("helvetica", "normal");
  let rowY = startY + 10;
  for (let i = 1; i < currentData.length; i++) {
    x = startX;
    currentData[i].forEach((cell, j) => {
      doc.text(cell.toString(), x + 2, rowY + 7);
      doc.rect(x, rowY, colWidths[j], 10);
      x += colWidths[j];
    });
    rowY += 10;
  }

  doc.save(currentClass + "-DisciplineReport.pdf");
}

// Map class to GID
function getGID(cls) {
  const map = {
    "S1A": "35480693",
    "S1B": "505752934",
    "S1C": "1563305402",
    "S2A": "1076797302",
    "S2B": "790046109",
    "S3A": "2059231041",
    "S3B": "1973310230"
  };
  return map[cls] || "";
}
</script>
</body>
</html>
